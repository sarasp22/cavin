<div class="wine-form-container">
  <div class="wine-form-card">
    <div class="wine-form-header">
      <div class="wine-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 2h8l2 10-4 10-4-10z"/>
          <ellipse cx="12" cy="2" rx="4" ry="1"/>
        </svg>
      </div>
      <h1 class="wine-form-title">Ajouter un Vin</h1>
      <p class="wine-form-subtitle">Ajoutez une nouvelle bouteille à <%= @storage.name %></p>
    </div>

    <%= form_with model: [@storage, @wine], class: "wine-form", id: "wine-form" do |f| %>
      <% if current_user.wine_templates.any? %>
        <div class="wine-form-group">
          <label class="wine-form-label">
            Sélectionner depuis ma bibliothèque
          </label>
          <select class="wine-form-input" id="wine-template-select" onchange="fillFromTemplate()">
            <option value="">-- Choisir un vin sauvegardé --</option>
            <% current_user.wine_templates.order(:name).each do |template| %>
              <option value="<%= template.id %>"
                      data-name="<%= template.name %>"
                      data-type="<%= template.wine_type %>"
                      data-region="<%= template.region %>"
                      data-price="<%= template.price %>">
                <%= template.name %> (<%= template.wine_type %> - <%= template.region %>)
              </option>
            <% end %>
          </select>
          <p class="form-hint">Ou remplissez manuellement ci-dessous</p>
        </div>
      <% end %>

      <div class="wine-form-group">
        <%= f.label :name, "Nom du Vin", class: "wine-form-label" %>
        <%= f.text_field :name, placeholder: "Ex: Château Margaux 2015", class: "wine-form-input", required: true, id: "wine-name" %>
      </div>

      <div class="wine-form-group">
        <%= f.label :wine_type, "Type de Vin", class: "wine-form-label" %>
        <div class="wine-type-buttons">
          <% ["Rouge", "Blanc", "Rosé", "Champagne", "Pétillant"].each do |type| %>
            <label class="wine-type-option">
              <%= f.radio_button :wine_type, type, class: "wine-type-radio", required: true %>
              <span class="wine-type-label <%= type.downcase %>"><%= type %></span>
            </label>
          <% end %>
        </div>
      </div>

      <div class="wine-form-group">
        <%= f.label :region, "Région", class: "wine-form-label" %>
        <%= f.text_field :region, placeholder: "Ex: Bordeaux, Bourgogne, Toscane...", class: "wine-form-input", required: true %>
      </div>

      <div class="wine-form-group">
        <%= f.label :price, "Prix (€)", class: "wine-form-label" %>
        <div class="input-with-currency">
          <%= f.number_field :price, step: 0.01, min: 0, placeholder: "0.00", class: "wine-form-input price-input", required: true %>
          <span class="currency-symbol">€</span>
        </div>
      </div>

      <div class="wine-form-section">
        <h3 class="section-title">Positions dans le Stockage</h3>
        <p class="section-explanation" style="font-size: 0.9rem; color: #6b6b6b; margin-bottom: 15px; font-style: italic;">
          Vous avez plusieurs bouteilles du même vin ? Sélectionnez simplement tous les emplacements souhaités ci-dessous pour les ajouter en une seule fois.
        </p>

        <%= hidden_field_tag :selected_positions, "", id: "selected-positions-input" %>

        <div class="position-preview">
          <p class="preview-label">Sélectionnez les emplacements (<span id="count-display" style="font-weight: bold; color: #4caf50;">0</span> bouteilles)</p>
          <div class="preview-grid" id="position-preview" style="grid-template-columns: repeat(<%= @storage.cols %>, 1fr);">
            <% (@storage.rows * @storage.cols).times do |index| %>
              <% row = (index / @storage.cols) + 1 %>
              <% col = (index % @storage.cols) + 1 %>
              <% wine = @storage.wines.where(consumed_at: nil).find { |w| w.row_position == row && w.col_position == col } %>

              <div class="preview-slot <%= 'occupied' if wine %>"
                   data-row="<%= row %>"
                   data-col="<%= col %>"
                   onclick="togglePosition(this, <%= row %>, <%= col %>)">
                <% if wine %>
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 2h8l2 10-4 10-4-10z"/>
                    <ellipse cx="12" cy="2" rx="4" ry="1"/>
                  </svg>
                <% else %>
                  <span class="slot-label">R<%= row %>C<%= col %></span>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <div class="wine-form-actions" style="display: flex; justify-content: center; gap: 20px; margin-top: 40px; width: 100%;">
        <%= link_to "Annuler", storage_path(@storage), class: "btn-cancel", style: "margin: 0;" %>
        <%= f.submit "Ajouter le Vin", class: "btn-submit-wine", style: "margin: 0;" %>
      </div>
    <% end %>
  </div>
</div>

<script>
  let selectedPositions = [];

  function togglePosition(element, row, col) {
    if (element.classList.contains('occupied')) return;
    const posIndex = selectedPositions.findIndex(p => p.row === row && p.col === col);
    if (posIndex > -1) {
      selectedPositions.splice(posIndex, 1);
      element.classList.remove('selected');
    } else {
      selectedPositions.push({row: row, col: col});
      element.classList.add('selected');
    }
    updateHiddenInput();
  }

  function updateHiddenInput() {
    const input = document.getElementById('selected-positions-input');
    const countDisplay = document.getElementById('count-display');
    const posString = selectedPositions.map(p => `${p.row}-${p.col}`).join(',');
    input.value = posString;
    countDisplay.textContent = selectedPositions.length;
  }

  function fillFromTemplate() {
    const select = document.getElementById('wine-template-select');
    const option = select.options[select.selectedIndex];
    if (option.value) {
      document.getElementById('wine-name').value = option.dataset.name;
      document.getElementById('wine_region').value = option.dataset.region;
      document.getElementById('wine_price').value = option.dataset.price;
      const type = option.dataset.type;
      const radio = document.querySelector(`input[name="wine[wine_type]"][value="${type}"]`);
      if (radio) radio.checked = true;
    }
  }
</script>
