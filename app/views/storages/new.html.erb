<div class="storage-form-container">
  <div class="storage-form-card">
    <h1 class="form-main-title">Ajouter Nouveau Stockage</h1>

    <%= form_with model: @storage, class: "storage-form", id: "storage-form" do |f| %>

      <!-- Nome dello Stockage -->
      <div class="form-section">
        <label class="form-section-label">Nom du Stockage</label>
        <div class="input-with-icon">
          <%= f.text_field :name, placeholder: "Ex: Ma Cave Principale", class: "form-text-input", required: true %>
          <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </div>
      </div>

      <!-- Tipo di Stockage -->
      <div class="form-section">
        <label class="form-section-label">Type de Stockage</label>
        <div class="storage-types-grid">
          <% Storage::CATEGORIES.each_with_index do |category, index| %>
            <div class="storage-type-card" onclick="selectCategory(this, '<%= category %>')">
              <%= f.radio_button :category, category, class: "storage-radio-input", id: "category_#{index}", required: true %>
              <label for="category_<%= index %>" class="storage-type-label">
                <div class="storage-type-image">
                  <% case category %>
                  <% when "Cave" %>
                    <%= image_tag "https://images.unsplash.com/photo-1510812431401-41d2bd2722f3?w=400", alt: "Cave", class: "category-img" %>
                  <% when "Vinothèque salon" %>
                    <%= image_tag "https://images.unsplash.com/photo-1558346490-a72e53ae2d4f?w=400", alt: "Vinothèque Salon", class: "category-img" %>
                  <% when "Meuble cuisine" %>
                    <%= image_tag "https://images.unsplash.com/photo-1578911373434-0cb395d2cbfb?w=400", alt: "Meuble Cuisine", class: "category-img" %>
                  <% when "Vinothèque cuisine" %>
                    <%= image_tag "https://images.unsplash.com/photo-1568213816046-0ee1c42bd559?w=400", alt: "Vinothèque Cuisine", class: "category-img" %>
                  <% end %>
                  <div class="storage-type-overlay">
                    <h3 class="storage-type-name"><%= category %></h3>
                  </div>
                </div>
              </label>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Dimensioni dello Stockage -->
      <div class="form-section">
        <label class="form-section-label">Dimensions du Stockage</label>

        <div class="dimensions-grid">
          <!-- Colonne -->
          <div class="dimension-control">
            <label class="dimension-label">Colonnes</label>
            <div class="dimension-input-group">
              <button type="button" class="dimension-btn" onclick="changeCols(-1)">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
              <%= f.number_field :cols, value: 2, min: 1, max: 20, class: "dimension-input", id: "cols-input", onchange: "updateGrid()" %>
              <button type="button" class="dimension-btn" onclick="changeCols(1)">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
            </div>
            <span class="dimension-subtitle">Colonnes</span>
          </div>

          <!-- Righe -->
          <div class="dimension-control">
            <label class="dimension-label">Rangées</label>
            <div class="dimension-input-group">
              <button type="button" class="dimension-btn" onclick="changeRows(-1)">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
              <%= f.number_field :rows, value: 3, min: 1, max: 20, class: "dimension-input", id: "rows-input", onchange: "updateGrid()" %>
              <button type="button" class="dimension-btn" onclick="changeRows(1)">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
            </div>
            <span class="dimension-subtitle">Rangées</span>
          </div>
        </div>

        <!-- Preview Grid -->
        <div class="grid-preview">
          <div class="grid-preview-container" id="grid-preview">
            <!-- Grid will be generated by JavaScript -->
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="form-actions">
        <%= f.submit "Créer Stockage", class: "btn-submit-storage" %>
      </div>
    <% end %>
  </div>
</div>

<script>
  // Initialize grid on page load
  document.addEventListener('DOMContentLoaded', function() {
    updateGrid();
  });

  // Select category
  function selectCategory(card, category) {
    // Remove active class from all cards
    document.querySelectorAll('.storage-type-card').forEach(c => {
      c.classList.remove('active');
    });

    // Add active class to clicked card
    card.classList.add('active');

    // Check the radio button
    const radio = card.querySelector('input[type="radio"]');
    if (radio) {
      radio.checked = true;
    }
  }

  // Change rows
  function changeRows(delta) {
    const input = document.getElementById('rows-input');
    let currentValue = parseInt(input.value) || 3;
    let newValue = currentValue + delta;

    if (newValue >= 1 && newValue <= 20) {
      input.value = newValue;
      updateGrid();
    }
  }

  // Change cols
  function changeCols(delta) {
    const input = document.getElementById('cols-input');
    let currentValue = parseInt(input.value) || 2;
    let newValue = currentValue + delta;

    if (newValue >= 1 && newValue <= 20) {
      input.value = newValue;
      updateGrid();
    }
  }

  // Update grid preview
  function updateGrid() {
    const rows = parseInt(document.getElementById('rows-input').value) || 3;
    const cols = parseInt(document.getElementById('cols-input').value) || 2;
    const gridPreview = document.getElementById('grid-preview');

    // Update grid template
    gridPreview.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

    // Clear existing bottles
    gridPreview.innerHTML = '';

    // Create bottle slots
    const totalSlots = rows * cols;
    for (let i = 0; i < totalSlots; i++) {
      const slot = document.createElement('div');
      slot.className = 'bottle-slot';
      slot.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 2h8l2 10-4 10-4-10z"/>
          <ellipse cx="12" cy="2" rx="4" ry="1"/>
        </svg>
      `;
      gridPreview.appendChild(slot);
    }
  }
</script>
