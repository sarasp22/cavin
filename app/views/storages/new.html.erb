<div class="storage-form-container">
  <div class="storage-form-card">
    <h1 class="form-main-title">Ajouter Nouveau Stockage</h1>

    <%= form_with model: @storage, class: "storage-form", id: "storage-form" do |f| %>

      <div class="form-section">
        <label class="form-section-label">Nom du Stockage</label>
        <div class="input-with-icon">
          <%= f.text_field :name, placeholder: "Ex: Ma Cave Principale", class: "form-text-input", required: true %>
          <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </div>
      </div>

      <div class="form-section">
        <label class="form-section-label">Type de Stockage</label>
        <div class="storage-types-grid">
          <% Storage::CATEGORIES.each_with_index do |category, index| %>
            <div class="storage-type-card" onclick="selectCategory(this, '<%= category %>')">
              <%= f.radio_button :category, category, class: "storage-radio-input", id: "category_#{index}", required: true %>
              <label for="category_<%= index %>" class="storage-type-label">
                <div class="storage-type-image">
               <% case category %>
                    <% when "Cave" %>
                  <%= image_tag "cave.jpg", alt: "Cave", class: "category-img" %>
                     <% when "Vinothèque salon" %>
                 <%= image_tag "vinotheque_salon.png", alt: "Vinothèque Salon", class: "category-img" %>
                     <% when "Meuble cuisine" %>
                 <%= image_tag "meuble_cuisine.jpg", alt: "Meuble Cuisine", class: "category-img" %>
                     <% when "Vinothèque cuisine" %>
                  <%= image_tag "vinotheque_cuisine.png", alt: "Vinothèque Cuisine", class: "category-img" %>
              <% end %>
                  <div class="storage-type-overlay">
                    <h3 class="storage-type-name"><%= category %></h3>
                  </div>
                </div>
              </label>
            </div>
          <% end %>
        </div>
      </div>

      <div class="form-section">
        <label class="form-section-label">Dimensions du Stockage</label>

        <div class="dimensions-grid">
          <div class="dimension-control">
            <label class="dimension-label">Colonnes</label>
            <div class="dimension-input-group">
              <button type="button" class="dimension-btn" onclick="changeCols(-1)">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
              <%= f.number_field :cols, value: 2, min: 1, max: 20, class: "dimension-input", id: "cols-input", onchange: "updateGrid()" %>
              <button type="button" class="dimension-btn" onclick="changeCols(1)">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
            </div>
            <span class="dimension-subtitle">Colonnes</span>
          </div>

          <div class="dimension-control">
            <label class="dimension-label">Rangées</label>
            <div class="dimension-input-group">
              <button type="button" class="dimension-btn" onclick="changeRows(-1)">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
              <%= f.number_field :rows, value: 3, min: 1, max: 20, class: "dimension-input", id: "rows-input", onchange: "updateGrid()" %>
              <button type="button" class="dimension-btn" onclick="changeRows(1)">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
            </div>
            <span class="dimension-subtitle">Rangées</span>
          </div>
        </div>

        <div class="grid-preview">
          <div class="grid-preview-container" id="grid-preview">

          </div>
        </div>
      </div>


      <div class="form-actions">
        <%= f.submit "Créer Stockage", class: "btn-submit-storage" %>
      </div>
    <% end %>
  </div>
</div>

<script>

  document.addEventListener('DOMContentLoaded', function() {
    updateGrid();
  });

  function selectCategory(card, category) {

      document.querySelectorAll('.storage-type-card').forEach(c => {
      c.classList.remove('active');
    });

    card.classList.add('active');

    const radio = card.querySelector('input[type="radio"]');
    if (radio) {
      radio.checked = true;
    }
  }

  function changeRows(delta) {
    const input = document.getElementById('rows-input');
    let currentValue = parseInt(input.value) || 3;
    let newValue = currentValue + delta;

    if (newValue >= 1 && newValue <= 20) {
      input.value = newValue;
      updateGrid();
    }
  }

  function changeCols(delta) {
    const input = document.getElementById('cols-input');
    let currentValue = parseInt(input.value) || 2;
    let newValue = currentValue + delta;

    if (newValue >= 1 && newValue <= 20) {
      input.value = newValue;
      updateGrid();
    }
  }

  function updateGrid() {
    const rows = parseInt(document.getElementById('rows-input').value) || 3;
    const cols = parseInt(document.getElementById('cols-input').value) || 2;
    const gridPreview = document.getElementById('grid-preview');

    gridPreview.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

    gridPreview.innerHTML = '';

    const totalSlots = rows * cols;
    for (let i = 0; i < totalSlots; i++) {
      const slot = document.createElement('div');
      slot.className = 'bottle-slot';
      slot.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="#4a0e0e" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round">
  <path d="M10 2h4v2.5h-4z" fill="#4a0e0e" /> <path d="M10 4.5v5.5c0 0 0 1-1 2s-2 1.5-2 4v6c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2v-6c0-2.5-1-3-2-4s-1-2-1-2V4.5" />

  <rect x="8.5" y="14" width="7" height="5" rx="0.5" fill="white" stroke="#4a0e0e" stroke-width="0.5" />

  <line x1="10" y1="15.5" x2="14" y2="15.5" stroke-width="0.3" />
  <line x1="10" y1="16.5" x2="14" y2="16.5" stroke-width="0.3" />
  <line x1="11" y1="17.5" x2="13" y2="17.5" stroke-width="0.3" />

  <path d="M13.5 11.5c0.5 0.5 1 1.5 1 2.5" opacity="0.4" />
</svg>
      `;
      gridPreview.appendChild(slot);
    }
  }
</script>
